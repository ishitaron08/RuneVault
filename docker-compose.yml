version: '3.8'

services:
  # Next.js Application Service (using Neon DB)
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    image: runevault:latest
    container_name: runevault-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-3000}:3000"
    environment:
      # Neon DB Connection (from .env)
      DATABASE_URL: ${DATABASE_URL}
      
      # NextAuth Configuration
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      AUTH_SECRET: ${AUTH_SECRET}
      
      # Google OAuth
      GOOGLE_CLIENT_ID: ${AUTH_GOOGLE_ID}
      GOOGLE_CLIENT_SECRET: ${AUTH_GOOGLE_SECRET}
      AUTH_GOOGLE_ID: ${AUTH_GOOGLE_ID}
      AUTH_GOOGLE_SECRET: ${AUTH_GOOGLE_SECRET}
      
      # Solana & Encryption
      SOLANA_RPC: ${SOLANA_RPC:-https://api.mainnet-beta.solana.com}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      
      # AWS Configuration (if needed)
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      
      # Application Configuration
      NODE_ENV: production
      PORT: 3000
      HOSTNAME: 0.0.0.0
      
    networks:
      - runevault-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  runevault-network:
    driver: bridge